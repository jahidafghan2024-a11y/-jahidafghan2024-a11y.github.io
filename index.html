<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="theme-color" content="#080a0c"/>
<title>üëë KING'S TRACKER - Secure</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow:wght@300;400;500;600;700&family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:#080a0c; --s1:#0f1214; --s2:#161b1e; --s3:#1d2428;
  --border:#1f2a2f; --border2:#263035;
  --gold:#d4a017; --gold2:#f0c040; --gold-dim:rgba(212,160,23,.12);
  --green:#1db954; --green-dim:rgba(29,185,84,.12);
  --red:#e53935; --red-dim:rgba(229,57,53,.10);
  --blue:#1e88e5; --blue-dim:rgba(30,136,229,.12);
  --text:#e8edf0; --muted:#5a6a72; --muted2:#3a4a52;
  --fh:'Bebas Neue',sans-serif; --fb:'Barlow',sans-serif; --fc:'Barlow Condensed',sans-serif;
  --r:12px; --r-sm:8px;
}
*{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;-webkit-tap-highlight-color:transparent;}
body{font-family:var(--fb);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;
  background-image:radial-gradient(ellipse 70% 50% at 5% 10%,rgba(212,160,23,.05) 0%,transparent 55%),
    radial-gradient(ellipse 50% 70% at 95% 90%,rgba(29,185,84,.03) 0%,transparent 55%);}

.auth-screen{position:fixed;inset:0;background:linear-gradient(135deg,var(--bg) 0%,var(--s1) 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;padding:20px;}
.auth-screen.hidden{display:none;}
.auth-card{background:var(--s2);border:2px solid var(--border);border-radius:16px;padding:40px;
  width:100%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,0.5);text-align:center;}
.auth-title{font-family:var(--fh);font-size:2rem;color:var(--gold);margin-bottom:12px;letter-spacing:2px;}
.auth-subtitle{color:var(--muted);margin-bottom:32px;font-size:.9rem;}
.auth-input{width:100%;background:var(--s1);border:1px solid var(--border);border-radius:8px;
  padding:12px 16px;color:var(--text);margin-bottom:16px;font-size:.95rem;transition:all .25s;}
.auth-input:focus{outline:none;border-color:var(--gold);box-shadow:0 0 10px rgba(212,160,23,0.3);}
.auth-btn{width:100%;background:linear-gradient(135deg,var(--gold) 0%,var(--gold2) 100%);border:none;
  border-radius:8px;padding:12px;color:var(--bg);font-weight:700;font-size:.95rem;cursor:pointer;
  transition:all .25s;font-family:var(--fh);letter-spacing:1px;}
.auth-btn:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(212,160,23,0.3);}
.auth-btn:disabled{opacity:.5;cursor:not-allowed;}
.auth-info{background:rgba(29,185,84,0.1);border-left:3px solid var(--green);padding:12px;
  border-radius:6px;font-size:.8rem;color:var(--green);margin-top:24px;text-align:left;}
.lock-icon{font-size:3rem;margin-bottom:16px;}

.sidebar{position:fixed;top:0;left:0;bottom:0;width:68px;background:var(--s1);border-right:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;padding:16px 0 24px;gap:4px;z-index:200;}
.logo{font-family:var(--fh);font-size:1.5rem;color:var(--gold);margin-bottom:20px;letter-spacing:1px;}
.nb{width:44px;height:44px;border:none;border-radius:10px;background:transparent;color:var(--muted);
  font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.18s;}
.nb:hover{background:var(--s2);color:var(--text);}
.nb.on{background:var(--gold-dim);color:var(--gold);box-shadow:inset 0 0 0 1px rgba(212,160,23,.18);}
.nb .tip{position:absolute;left:56px;background:#000;color:#fff;font-family:var(--fc);font-size:.7rem;
  font-weight:700;letter-spacing:.8px;text-transform:uppercase;padding:5px 9px;border-radius:6px;
  white-space:nowrap;pointer-events:none;opacity:0;transition:.12s;z-index:300;}
.nb:hover .tip{opacity:1;}
.sb-gap{flex:1;}
.logout-btn{width:44px;height:44px;border:none;border-radius:10px;background:rgba(229,57,53,.2);
  color:var(--red);font-size:1rem;cursor:pointer;transition:.18s;border:1px solid rgba(229,57,53,.3);}
.logout-btn:hover{background:rgba(229,57,53,.3);}

.app{margin-left:68px;min-height:100vh;}
.topbar{padding:18px 28px;display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--border);background:linear-gradient(90deg,rgba(212,160,23,.04) 0%,transparent 40%);
  position:sticky;top:0;z-index:100;backdrop-filter:blur(12px);}
.topbar-l h1{font-family:var(--fh);font-size:1.8rem;color:var(--gold);letter-spacing:2px;line-height:1;}
.topbar-l p{color:var(--muted);font-size:.72rem;margin-top:2px;letter-spacing:.5px;text-transform:uppercase;}
.topbar-r{display:flex;gap:8px;align-items:center;}
.pill{background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:6px 13px;
  font-family:var(--fc);font-size:.82rem;font-weight:600;letter-spacing:.3px;}
.spill{display:flex;align-items:center;gap:5px;padding:5px 11px;background:var(--s2);border:1px solid var(--border);
  border-radius:20px;font-family:var(--fc);font-size:.68rem;font-weight:700;letter-spacing:.5px;
  text-transform:uppercase;color:var(--muted);}
.sdot{width:6px;height:6px;border-radius:50%;background:var(--muted);transition:.3s;flex-shrink:0;}
.sdot.ok{background:var(--green);box-shadow:0 0 5px rgba(29,185,84,.4);}
.sdot.err{background:var(--red);}
.sdot.spin{animation:blink .8s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.2;}}

.page{display:none;padding:24px 28px;padding-bottom:32px;}
.page.on{display:block;animation:fu .22s ease;}
@keyframes fu{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.sec{font-family:var(--fc);font-size:.75rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;
  color:var(--muted);margin-bottom:13px;display:flex;align-items:center;gap:10px;}
.sec::after{content:'';flex:1;height:1px;background:var(--border);}

.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:22px;}
.sc{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:16px 14px;
  position:relative;overflow:hidden;}
.sc::after{content:'';position:absolute;top:-20px;right:-20px;width:70px;height:70px;border-radius:50%;
  background:radial-gradient(circle,rgba(212,160,23,.07) 0%,transparent 70%);}
.sc-lbl{font-size:.63rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--muted);margin-bottom:6px;font-weight:700;}
.sc-val{font-family:var(--fh);font-size:2rem;line-height:1;color:var(--gold);}
.sc-sub{font-size:.72rem;color:var(--muted);margin-top:3px;}
.sc.c-g .sc-val{color:var(--green);}.sc.c-b .sc-val{color:var(--blue);}

.ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-bottom:22px;}
.ach-tile{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:14px;
  display:flex;flex-direction:column;align-items:center;text-align:center;cursor:pointer;
  transition:.2s;min-height:140px;opacity:.3;}
.ach-tile.unlocked{opacity:1;border-color:var(--gold);box-shadow:inset 0 0 0 1px rgba(212,160,23,.3),0 0 15px rgba(212,160,23,.2);}
.ach-icon{font-size:2.2rem;margin-bottom:8px;filter:grayscale(1);transition:.2s;}
.ach-tile.unlocked .ach-icon{filter:grayscale(0);transform:scale(1.15);}
.ach-name{font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.ach-tile.unlocked .ach-name{color:var(--gold);}
.ach-desc{font-size:.6rem;color:var(--muted);margin-top:4px;opacity:0;transition:.2s;}
.ach-tile.unlocked .ach-desc{opacity:1;color:var(--green);}

.perf{display:grid;grid-template-columns:auto 1fr;gap:20px;align-items:center;background:var(--s1);
  border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:22px;}
.ring{position:relative;width:96px;height:96px;flex-shrink:0;}
.ring svg{transform:rotate(-90deg);}
.ring-txt{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.ring-pct{font-family:var(--fh);font-size:1.5rem;color:var(--gold);}
.ring-lbl{font-size:.55rem;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);}
.perf-r h2{font-family:var(--fh);font-size:1.4rem;letter-spacing:1px;margin-bottom:4px;}
.perf-r p{color:var(--muted);font-size:.82rem;line-height:1.5;}
.coach{margin-top:9px;font-size:.8rem;font-weight:600;padding:7px 12px;border-radius:7px;display:inline-block;
  background:var(--gold-dim);color:var(--gold);border-left:3px solid var(--gold);}
.coach.g{background:var(--green-dim);color:var(--green);border-color:var(--green);}
.coach.r{background:var(--red-dim);color:var(--red);border-color:var(--red);}

.hgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:22px;}
.hp{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:12px 14px;
  display:flex;align-items:center;gap:10px;cursor:pointer;transition:.18s;}
.hp:hover{border-color:var(--border2);background:var(--s2);}
.hp:active{transform:scale(.97);}
.hp.done{border-color:rgba(29,185,84,.3);background:var(--green-dim);}
.hem{width:32px;height:32px;border-radius:7px;background:var(--s2);display:flex;align-items:center;
  justify-content:center;font-size:1.1rem;flex-shrink:0;}
.hp.done .hem{background:rgba(29,185,84,.15);}
.hi{flex:1;min-width:0;}
.hn{font-size:.83rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hv{font-size:.72rem;color:var(--muted);margin-top:2px;}
.hp.done .hv{color:var(--green);}
.hchk{width:20px;height:20px;border-radius:50%;border:1.5px solid var(--border2);flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:.6rem;}
.hp.done .hchk{background:var(--green);border-color:var(--green);color:#fff;}

.streak-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-bottom:22px;}
.streak-card{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:14px;position:relative;overflow:hidden;}
.streak-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--gold),var(--green));opacity:.5;}
.streak-emoji{font-size:1.8rem;margin-bottom:8px;}
.streak-title{font-size:.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-weight:700;}
.streak-count{font-family:var(--fh);font-size:1.8rem;color:var(--gold);line-height:1;margin:4px 0;}
.streak-sub{font-size:.7rem;color:var(--muted);}

.charts{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:22px;}
.cc{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:18px;}
.cc h3{font-family:var(--fc);font-size:.72rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:13px;}
.cc canvas{max-height:185px;}

.inp{width:100%;background:var(--s1);border:1px solid var(--border);border-radius:8px;padding:10px 14px;
  color:var(--text);margin-bottom:14px;font-size:.9rem;transition:.25s;}
.inp:focus{outline:none;border-color:var(--gold);box-shadow:0 0 8px rgba(212,160,23,.25);}
.sel{width:100%;background:var(--s1);border:1px solid var(--border);border-radius:8px;padding:10px;
  color:var(--text);margin-bottom:14px;cursor:pointer;}
.btn{padding:10px 20px;border:none;border-radius:8px;background:linear-gradient(135deg,var(--gold),var(--gold2));
  color:var(--bg);font-weight:700;cursor:pointer;transition:.2s;font-family:var(--fh);letter-spacing:1px;}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(212,160,23,.3);}
.btn-sm{padding:6px 12px;font-size:.8rem;}
.btn-del{background:var(--red-dim);color:var(--red);border:1px solid rgba(229,57,53,.3);}

.summary-card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:24px;margin-bottom:22px;}
.summary-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:1px solid var(--border);padding-bottom:16px;}
.summary-title{font-family:var(--fh);font-size:1.3rem;color:var(--gold);letter-spacing:1px;}
.summary-period{color:var(--muted);font-size:.8rem;text-transform:uppercase;}
.summary-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px;}
.stat-mini{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;}
.stat-mini-val{font-family:var(--fh);font-size:1.8rem;color:var(--gold);line-height:1;}
.stat-mini-lbl{font-size:.7rem;color:var(--muted);text-transform:uppercase;margin-top:8px;}
.summary-feedback{background:linear-gradient(135deg,rgba(212,160,23,.1),rgba(29,185,84,.1));border-left:4px solid var(--gold);padding:18px;border-radius:8px;margin-bottom:16px;}
.feedback-title{font-family:var(--fh);font-size:1.1rem;color:var(--gold);margin-bottom:8px;}
.feedback-text{color:var(--text);font-size:.9rem;line-height:1.6;}
.feedback-emoji{font-size:1.8rem;margin-right:8px;}
.summary-habit-list{display:grid;gap:10px;}
.summary-habit-row{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;}
.habit-name-summary{color:var(--text);font-weight:600;font-size:.9rem;}
.habit-percent{font-family:var(--fh);font-size:1.1rem;color:var(--gold);}
.habit-percent.good{color:var(--green);}
.habit-percent.bad{color:var(--red);}
.week-days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:16px;}
.day-cell{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center;cursor:default;transition:all .2s;}
.day-cell.complete{background:var(--green-dim);border-color:var(--green);}
.day-label{font-size:.7rem;color:var(--muted);text-transform:uppercase;margin-bottom:6px;}
.day-date{font-size:.75rem;color:var(--text);font-weight:600;}
.day-pct{font-size:.65rem;color:var(--muted);margin-top:4px;}

.toast{position:fixed;bottom:32px;left:50%;transform:translateX(-50%) translateY(120px);background:var(--s2);
  border:1px solid var(--border);color:var(--text);padding:14px 20px;border-radius:10px;font-size:.9rem;
  font-weight:600;z-index:500;transition:.3s;box-shadow:0 10px 30px rgba(0,0,0,.4);pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.ok{border-color:rgba(29,185,84,.5);background:rgba(29,185,84,.15);}
.toast.err{border-color:rgba(229,57,53,.5);background:rgba(229,57,53,.15);}

@media (max-width:768px){
  .sidebar{width:60px;}.app{margin-left:60px;}.nb{width:40px;height:40px;font-size:1rem;}
  .stats-row{grid-template-columns:repeat(2,1fr);}.charts{grid-template-columns:1fr;}
  .page{padding:16px 20px;}.topbar{padding:14px 20px;}.topbar-l h1{font-size:1.3rem;}
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="authScreen" class="auth-screen">
  <div class="auth-card">
    <div class="lock-icon">üîê</div>
    <div class="auth-title">KING'S TRACKER</div>
    <div class="auth-subtitle">Secure Access</div>
    <input type="password" class="auth-input" id="authPassword" placeholder="Enter Access Code" onkeypress="if(event.key==='Enter')authLogin()">
    <button class="auth-btn" onclick="authLogin()">UNLOCK</button>
    <div class="auth-info">
      <strong>üîí Security:</strong> This app requires a code. Set your code in Settings to prevent unauthorized access.
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="logo">üëë</div>
  <button class="nb on" onclick="go('dashboard')" title="Dashboard"><span class="tip">Dashboard</span>üìä</button>
  <button class="nb" onclick="go('entry')" title="Log"><span class="tip">Log</span>‚úèÔ∏è</button>
  <button class="nb" onclick="go('achievements')" title="Achievements"><span class="tip">Achievements</span>üèÜ</button>
  <button class="nb" onclick="go('history')" title="History"><span class="tip">History</span>üìÖ</button>
  <button class="nb" onclick="go('reports')" title="Reports"><span class="tip">Reports</span>üìà</button>
  <button class="nb" onclick="go('setup')" title="Settings"><span class="tip">Settings</span>‚öôÔ∏è</button>
  <div class="sb-gap"></div>
  <button class="logout-btn" onclick="authLogout()" title="Logout">üö™</button>
</div>

<!-- APP -->
<div class="app">
  <div class="topbar">
    <div class="topbar-l">
      <h1>KING'S TRACKER</h1>
      <p id="dpill">Today</p>
    </div>
    <div class="topbar-r">
      <div class="spill">
        <div class="sdot ok" id="sdot"></div>
        <span id="slbl">LOCAL</span>
      </div>
    </div>
  </div>

  <div id="page-dashboard" class="page on">
    <div class="sec">DAILY PERFORMANCE</div>
    <div class="perf">
      <div class="ring">
        <svg viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" fill="none" stroke="var(--border)" stroke-width="6" opacity=".2"/>
          <circle id="ringC" cx="50" cy="50" r="45" fill="none" stroke="var(--gold)" stroke-width="6" 
                  stroke-dasharray="282.74" stroke-dashoffset="282.74" stroke-linecap="round" 
                  style="transform: rotate(-90deg); transform-origin: 50px 50px; transition: stroke-dashoffset 0.5s;"/>
        </svg>
        <div class="ring-txt">
          <div class="ring-pct" id="rpct">0%</div>
          <div class="ring-lbl">COMPLETE</div>
        </div>
      </div>
      <div class="perf-r">
        <h2 id="ptitle">MISSION AWAITS</h2>
        <p id="psub">No entries yet</p>
        <div class="coach" id="coach">Start your journey!</div>
      </div>
    </div>

    <div class="sec">TODAY'S STATS</div>
    <div class="stats-row">
      <div class="sc">
        <div class="sc-lbl">Completed</div>
        <div class="sc-val" id="s-done">0</div>
        <div class="sc-sub">of <span id="s-total">0</span></div>
      </div>
      <div class="sc c-g">
        <div class="sc-lbl">Current Streak</div>
        <div class="sc-val" id="s-streak">0</div>
        <div class="sc-sub">üî• days</div>
      </div>
      <div class="sc c-b">
        <div class="sc-lbl">Best Streak</div>
        <div class="sc-val" id="s-best">0</div>
        <div class="sc-sub">personal best</div>
      </div>
      <div class="sc">
        <div class="sc-lbl">Achievements</div>
        <div class="sc-val" id="s-ach">0</div>
        <div class="sc-sub">unlocked</div>
      </div>
    </div>

    <div class="sec">TODAY'S HABITS</div>
    <div class="hgrid" id="hgrid"></div>

    <div class="sec">STREAKS</div>
    <div class="streak-grid" id="streak-grid"></div>

    <div class="sec">PROGRESS</div>
    <div class="charts">
      <div class="cc">
        <h3>Weekly</h3>
        <canvas id="chart-weekly"></canvas>
      </div>
      <div class="cc">
        <h3>Habits</h3>
        <canvas id="chart-habits"></canvas>
      </div>
    </div>
  </div>

  <div id="page-entry" class="page">
    <div class="sec">LOG PROGRESS</div>
    <div id="entry-area"></div>
  </div>

  <div id="page-achievements" class="page">
    <div class="sec">ACHIEVEMENTS</div>
    <p style="color:var(--muted);margin-bottom:20px;font-size:.9rem;">Unlock badges by building streaks!</p>
    <div class="ach-grid" id="ach-grid"></div>
  </div>

  <div id="page-history" class="page">
    <div class="sec">HISTORY</div>
    <div id="history-area"></div>
  </div>

  <div id="page-reports" class="page">
    <div class="sec">PERFORMANCE SUMMARY</div>
    
    <!-- WEEKLY SUMMARY -->
    <div class="summary-card">
      <div class="summary-header">
        <div>
          <div class="summary-title">üìä WEEKLY SUMMARY</div>
          <div class="summary-period" id="weekly-period"></div>
        </div>
      </div>
      
      <div class="summary-stats">
        <div class="stat-mini">
          <div class="stat-mini-val" id="week-avg">0%</div>
          <div class="stat-mini-lbl">Avg Completion</div>
        </div>
        <div class="stat-mini">
          <div class="stat-mini-val" id="week-best">0%</div>
          <div class="stat-mini-lbl">Best Day</div>
        </div>
        <div class="stat-mini">
          <div class="stat-mini-val" id="week-days-complete">0</div>
          <div class="stat-mini-lbl">Days Complete</div>
        </div>
      </div>

      <div class="summary-feedback" id="weekly-feedback">
        <div class="feedback-title"><span class="feedback-emoji">üìà</span>Weekly Assessment</div>
        <div class="feedback-text">Your weekly performance summary will appear here.</div>
      </div>

      <div style="margin-top:16px;">
        <div style="color:var(--muted);font-size:.8rem;text-transform:uppercase;margin-bottom:12px;font-weight:700;">7-Day Overview</div>
        <div class="week-days" id="weekly-days"></div>
      </div>
    </div>

    <!-- MONTHLY SUMMARY -->
    <div class="summary-card">
      <div class="summary-header">
        <div>
          <div class="summary-title">üìÖ MONTHLY SUMMARY</div>
          <div class="summary-period" id="monthly-period"></div>
        </div>
      </div>
      
      <div class="summary-stats">
        <div class="stat-mini">
          <div class="stat-mini-val" id="month-avg">0%</div>
          <div class="stat-mini-lbl">Avg Completion</div>
        </div>
        <div class="stat-mini">
          <div class="stat-mini-val" id="month-best">0%</div>
          <div class="stat-mini-lbl">Best Day</div>
        </div>
        <div class="stat-mini">
          <div class="stat-mini-val" id="month-days">0</div>
          <div class="stat-mini-lbl">Days Tracked</div>
        </div>
      </div>

      <div class="summary-feedback" id="monthly-feedback">
        <div class="feedback-title"><span class="feedback-emoji">üéØ</span>Monthly Assessment</div>
        <div class="feedback-text">Your monthly performance summary will appear here.</div>
      </div>

      <div style="margin-top:20px;">
        <div style="color:var(--muted);font-size:.8rem;text-transform:uppercase;margin-bottom:12px;font-weight:700;">Habit Performance</div>
        <div class="summary-habit-list" id="monthly-habits"></div>
      </div>
    </div>
  </div>

  <div id="page-setup" class="page">
    <div class="sec">SETTINGS</div>
    
    <div style="background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:20px;">
      <h3 style="color:var(--gold);margin-bottom:14px;font-family:var(--fh);">üîê SECURITY</h3>
      <label style="color:var(--muted);font-size:.8rem;display:block;margin-bottom:8px;">Access Code (min 4 characters)</label>
      <input class="inp" type="password" id="accessCode" placeholder="Set your access code...">
      <button class="btn" onclick="saveAccessCode()">SAVE CODE</button>
      <p style="color:var(--muted);font-size:.75rem;margin-top:10px;">‚ö†Ô∏è Only people with this code can access your data</p>
    </div>

    <div style="background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:20px;">
      <h3 style="color:var(--gold);margin-bottom:14px;font-family:var(--fh);">üìä GOOGLE SHEETS SYNC</h3>
      <label style="color:var(--muted);font-size:.8rem;display:block;margin-bottom:8px;">Apps Script URL</label>
      <input class="inp" id="surl" placeholder="https://script.google.com/macros/d/...">
      <button class="btn" onclick="saveSheetUrl()">SAVE & SYNC</button>
      <p style="color:var(--muted);font-size:.75rem;margin-top:10px;">‚úÖ Optional: Connect to Google Sheets for cloud backup</p>
    </div>

    <div style="background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:20px;">
      <h3 style="color:var(--gold);margin-bottom:14px;font-family:var(--fh);">‚ûï NEW HABIT</h3>
      <input class="inp" id="nn" placeholder="Name (e.g., Pythonüêç)">
      <input class="inp" id="nq" placeholder="Daily question (optional)">
      <select class="sel" id="nt">
        <option value="toggle">Toggle (Yes/No)</option>
        <option value="number">Number</option>
        <option value="slider">Energy (1-10)</option>
        <option value="pray">Prayer (1-5)</option>
        <option value="notes">Notes</option>
      </select>
      <button class="btn" onclick="addSubject()">ADD</button>
    </div>

    <div style="background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:20px;">
      <h3 style="color:var(--gold);margin-bottom:14px;font-family:var(--fh);">üìã YOUR HABITS</h3>
      <div id="slist"></div>
    </div>

    <button class="btn" onclick="resetData()" style="width:100%;background:var(--red-dim);color:var(--red);border:1px solid rgba(229,57,53,.3);">RESET ALL</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const AUTH_KEY = 'kt_access_code';
const SK = { url:'kt_url', subjects:'kt_subjects', history:'kt_history', achievements:'kt_ach' };
const DEFAULT_SUBJECTS = [
  { name:'Pythonüêç', type:'toggle', q:'Did you code today?', def:'No' },
  { name:'GYMüí™', type:'toggle', q:'Did you hit the gym?', def:'No' },
  { name:'Moodüß†', type:'slider', q:'Energy (1-10)?', def:'5' },
  { name:'Prayüôè', type:'pray', q:'Prayers (1-5)?', def:'0' },
];
const ACHIEVEMENTS = [
  { id:'first', icon:'‚úÖ', name:'First Step', desc:'Log 1 habit', check:(h,a)=>h.length>0 },
  { id:'week', icon:'üí™', name:'Week Warrior', desc:'7-day streak', check:(h,a)=>a.bestStreak>=7 },
  { id:'month', icon:'üëë', name:'Month Master', desc:'30-day streak', check:(h,a)=>a.bestStreak>=30 },
  { id:'all', icon:'üî•', name:'All In', desc:'100% today', check:(h,a)=>a.today===100 },
  { id:'consistent', icon:'‚≠ê', name:'Consistent', desc:'10-day streak', check:(h,a)=>a.bestStreak>=10 },
  { id:'legend', icon:'üèÜ', name:'Legend', desc:'100-day', check:(h,a)=>a.bestStreak>=100 },
];

let isAuthenticated = false;
let SHEET_URL = localStorage.getItem(SK.url) || '';
let subjects = JSON.parse(localStorage.getItem(SK.subjects) || 'null') || DEFAULT_SUBJECTS;
let history = JSON.parse(localStorage.getItem(SK.history) || '[]');
let achievements = JSON.parse(localStorage.getItem(SK.achievements) || '[]');
let todayStr = '';
let wChart = null, sChart = null;
let sheetOk = false;

function authLogin() {
  const inputCode = document.getElementById('authPassword').value;
  const savedCode = localStorage.getItem(AUTH_KEY);
  if (savedCode && inputCode !== savedCode) {
    toast('‚ùå Wrong code!', 'err');
    return;
  }
  isAuthenticated = true;
  document.getElementById('authScreen').classList.add('hidden');
  init();
}

function authLogout() {
  if (confirm('Logout?')) {
    isAuthenticated = false;
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('authPassword').value = '';
    document.getElementById('authPassword').focus();
  }
}

function saveAccessCode() {
  const code = document.getElementById('accessCode').value.trim();
  if (code.length < 4) {
    toast('‚ö†Ô∏è Min 4 chars', 'err');
    return;
  }
  localStorage.setItem(AUTH_KEY, code);
  toast('‚úÖ Code saved!', 'ok');
  document.getElementById('accessCode').value = '';
}

function init() {
  const now = new Date();
  todayStr = ldate(now);
  document.getElementById('dpill').textContent = now.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
  document.getElementById('surl').value = SHEET_URL;
  ensureToday();
  renderAll();
  if (SHEET_URL) syncFromSheet();
}

document.addEventListener('DOMContentLoaded', () => {
  const savedCode = localStorage.getItem(AUTH_KEY);
  if (savedCode) {
    document.getElementById('authScreen').classList.remove('hidden');
  } else {
    isAuthenticated = true;
    init();
  }
});

function go(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('on'));
  document.querySelectorAll('.nb').forEach(b => b.classList.remove('on'));
  document.getElementById('page-' + id).classList.add('on');
  const btns = document.querySelectorAll('.nb');
  const idx = ['dashboard','entry','achievements','history','reports','setup'].indexOf(id);
  if (btns[idx]) btns[idx].classList.add('on');
  if (id === 'history') renderHistory();
  if (id === 'reports') renderReports();
  if (id === 'setup') renderSubjects();
  if (id === 'achievements') renderAch();
  window.scrollTo(0, 0);
}

async function syncFromSheet() {
  setSS('spin', 'SYNCING');
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 8000);
    const res = await fetch(SHEET_URL + '?action=getData&t=' + Date.now(), { signal: controller.signal });
    clearTimeout(timeout);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    if (data.subjects?.length) {
      const existing = subjects.map(s => s.name);
      data.subjects.forEach(name => {
        if (!existing.includes(name))
          subjects.push({ name, type: guessType(name), q: `Update ${name}`, def: '0' });
      });
      saveSubjects();
    }
    if (data.history?.length) {
      data.history.forEach(r => {
        if (r.date === todayStr) return;
        const i = history.findIndex(x => x.date === r.date);
        if (i === -1) history.push(r); else history[i] = r;
      });
      saveHistory();
    }
    sheetOk = true;
    setSS('ok', 'SYNCED');
    renderAll();
    toast('‚úÖ Synced!', 'ok');
  } catch (e) {
    sheetOk = false;
    setSS('err', 'LOCAL');
  }
}

async function pushLog(dateStr, values) {
  if (!SHEET_URL || !sheetOk) return;
  try {
    const p = new URLSearchParams({ action: 'webLog', date: dateStr });
    Object.entries(values).forEach(([k, v]) => p.append('v_' + k, v));
    const res = await fetch(SHEET_URL + '?' + p + '&t=' + Date.now());
    const data = await res.json();
    if (data.ok) { toast('‚òÅÔ∏è Saved!', 'ok'); setSS('ok','SYNCED'); }
  } catch (e) { setSS('err','OFFLINE'); }
}

function setSS(state, label) {
  document.getElementById('sdot').className = 'sdot ' + (state==='ok'?'ok':state==='err'?'err':'spin');
  document.getElementById('slbl').textContent = label;
}

function saveSheetUrl() {
  const url = document.getElementById('surl').value.trim();
  if (!url) {
    localStorage.removeItem(SK.url);
    SHEET_URL = '';
    toast('‚úÖ Sync off', 'ok');
    return;
  }
  SHEET_URL = url;
  localStorage.setItem(SK.url, SHEET_URL);
  toast('‚úÖ URL saved!', 'ok');
  syncFromSheet();
}

function renderAll() { renderDash(); renderEntry(); }

function renderDash() {
  const rec = todayRec();
  const checks = rec.checks || {};
  const total = subjects.length;
  let done = 0;
  subjects.forEach(s => { if (isDone(s, checks[s.name])) done++; });
  const pct = total ? Math.round(done / total * 100) : 0;

  document.getElementById('s-done').textContent = done;
  document.getElementById('s-total').textContent = total;
  document.getElementById('s-streak').textContent = getStreak();
  document.getElementById('s-best').textContent = bestStreak();
  document.getElementById('s-ach').textContent = achievements.length;

  const C = 282.74;
  document.getElementById('ringC').style.strokeDashoffset = C - (pct / 100) * C;
  document.getElementById('rpct').textContent = pct + '%';

  let title, sub, msg, cls = '';
  if (pct >= 80)      { title='KING STATUS üëë'; sub='Crushing it!'; msg='üî• Keep momentum!'; cls='g'; }
  else if (pct >= 50) { title='SOLID PROGRESS üìà'; sub='Halfway!'; msg='üí™ Push harder!'; }
  else if (pct > 0)   { title='GETTING STARTED ‚ö°'; sub='Begun!'; msg='‚öîÔ∏è Dominate!'; cls='r'; }
  else                { title='MISSION AWAITS üéØ'; sub='Log first habit'; msg='‚òÄÔ∏è Start now!'; }
  document.getElementById('ptitle').textContent = title;
  document.getElementById('psub').textContent = sub;
  document.getElementById('coach').textContent = msg;
  document.getElementById('coach').className = 'coach ' + cls;

  const g = document.getElementById('hgrid');
  g.innerHTML = '';
  subjects.forEach(s => {
    const v = checks[s.name];
    const ok = isDone(s, v);
    const d = document.createElement('div');
    d.className = 'hp' + (ok ? ' done' : '');
    d.innerHTML = `<div class="hem">${emj(s.name)}</div><div class="hi"><div class="hn">${s.name}</div><div class="hv">${ok ? fmtV(s, v) : 'Not done'}</div></div><div class="hchk">${ok ? '‚úì' : ''}</div>`;
    d.onclick = () => go('entry');
    g.appendChild(d);
  });

  const sg = document.getElementById('streak-grid');
  sg.innerHTML = '';
  const cur = getStreak();
  const best = bestStreak();
  const s1 = document.createElement('div');
  s1.className = 'streak-card';
  s1.innerHTML = `<div class="streak-emoji">üî•</div><div class="streak-title">Current</div><div class="streak-count">${cur}</div><div class="streak-sub">days</div>`;
  sg.appendChild(s1);
  const s2 = document.createElement('div');
  s2.className = 'streak-card';
  s2.innerHTML = `<div class="streak-emoji">üëë</div><div class="streak-title">Best</div><div class="streak-count">${best}</div><div class="streak-sub">ever</div>`;
  sg.appendChild(s2);

  updateAch();
  renderCharts();
}

function renderEntry() {
  const rec = todayRec();
  const e = document.getElementById('entry-area');
  e.innerHTML = '';
  subjects.forEach(s => {
    const v = rec.checks[s.name] || '';
    let ctrl = '';
    if (s.type === 'toggle') {
      ctrl = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><button class="btn btn-sm" style="background:${v==='Yes'?'var(--green)':'var(--border)'};" onclick="logCheck('${s.name}','Yes')">‚úÖ Yes</button><button class="btn btn-sm" style="background:${v==='No'?'var(--red)':'var(--border)'};" onclick="logCheck('${s.name}','No')">‚ùå No</button></div>`;
    } else if (s.type === 'number') {
      ctrl = `<input class="inp" type="number" value="${v}" onchange="logCheck('${s.name}',this.value);">`;
    } else if (s.type === 'slider') {
      ctrl = `<input class="inp" type="range" min="1" max="10" value="${v||5}" oninput="logCheck('${s.name}',this.value); this.nextElementSibling.textContent='‚ö° '+this.value+'/10';"><div style="text-align:center;color:var(--muted);margin-top:8px;">‚ö° ${v||5}/10</div>`;
    } else if (s.type === 'pray') {
      ctrl = `<input class="inp" type="range" min="1" max="5" value="${v||3}" oninput="logCheck('${s.name}',this.value); this.nextElementSibling.textContent='üôè '+this.value+'/5';"><div style="text-align:center;color:var(--muted);margin-top:8px;">üôè ${v||3}/5</div>`;
    } else if (s.type === 'notes') {
      ctrl = `<textarea class="inp" onchange="logCheck('${s.name}',this.value);" style="min-height:80px;">${v}</textarea>`;
    }
    const d = document.createElement('div');
    d.style.cssText = 'background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:18px;margin-bottom:16px;';
    d.innerHTML = `<div style="font-size:1.6rem;margin-bottom:10px;">${emj(s.name)}</div><div style="color:var(--muted);font-size:.85rem;margin-bottom:12px;">${s.q}</div>${ctrl}`;
    e.appendChild(d);
  });
}

function renderCharts() {
  const last7 = history.slice(0, 7).reverse();
  const wlabels = last7.map(r => new Date(r.date).toLocaleDateString('en-US',{weekday:'short'}));
  const wdata = last7.map(r => {
    let done = 0;
    subjects.forEach(s => { if (isDone(s, r.checks[s.name])) done++; });
    return Math.round(done / Math.max(subjects.length, 1) * 100);
  });

  const c1 = document.getElementById('chart-weekly').getContext('2d');
  if (wChart) wChart.destroy();
  wChart = new Chart(c1, {
    type: 'line',
    data: { labels: wlabels, datasets: [{ label: '%', data: wdata, borderColor: '#d4a017', backgroundColor: 'rgba(212,160,23,.1)', borderWidth: 2, fill: true, tension: 0.4, pointBackgroundColor: '#d4a017', pointRadius: 4 }] },
    options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { max: 100, ticks: { color: '#5a6a72' } }, x: { ticks: { color: '#5a6a72' } } } }
  });

  const slabels = subjects.map(s => s.name.replace(/\p{Emoji}/gu,'').trim().substring(0,8));
  const sdata = subjects.map(s => {
    let done = 0;
    history.forEach(r => { if (isDone(s, r.checks[s.name])) done++; });
    return Math.round(done / Math.max(history.length, 1) * 100);
  });

  const c2 = document.getElementById('chart-habits').getContext('2d');
  if (sChart) sChart.destroy();
  sChart = new Chart(c2, {
    type: 'radar',
    data: { labels: slabels, datasets: [{ label: '%', data: sdata, borderColor: '#1db954', backgroundColor: 'rgba(29,185,84,.1)', pointBackgroundColor: '#d4a017', borderWidth: 2 }] },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { r: { max: 100, ticks: { color: '#5a6a72' } } } }
  });
}

function renderHistory() {
  const e = document.getElementById('history-area');
  e.innerHTML = '';
  const sorted = [...history].sort((a,b) => new Date(b.date) - new Date(a.date));
  if (!sorted.length) { e.innerHTML = '<p style="color:var(--muted);">No history.</p>'; return; }
  sorted.forEach(r => {
    const date = new Date(r.date);
    const dstr = date.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    let done = 0;
    subjects.forEach(s => { if (isDone(s, r.checks[s.name])) done++; });
    const pct = Math.round(done / Math.max(subjects.length, 1) * 100);
    const d = document.createElement('div');
    d.style.cssText = 'background:var(--s1);border:1px solid var(--border);border-radius:var(--r-sm);padding:14px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;';
    d.innerHTML = `<div><div style="color:var(--text);font-weight:700;">${dstr}</div><div style="font-size:.75rem;color:var(--muted);">${done}/${subjects.length}</div></div><div style="font-family:var(--fh);font-size:1.4rem;color:var(--gold);">${pct}%</div>`;
    e.appendChild(d);
  });
}

function renderReports() {
  // WEEKLY REPORT
  const now = new Date();
  const weekStart = new Date(now);
  weekStart.setDate(now.getDate() - now.getDay());
  
  const last7 = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(weekStart);
    d.setDate(d.getDate() + i);
    last7.push(d);
  }
  
  let weekTotal = 0, weekDaysComplete = 0, weekBest = 0;
  const weekData = last7.map((d, idx) => {
    const dateStr = ldate(d);
    const rec = history.find(r => r.date === dateStr) || { checks: {} };
    let done = 0;
    subjects.forEach(s => { if (isDone(s, rec.checks[s.name])) done++; });
    const pct = Math.round(done / Math.max(subjects.length, 1) * 100);
    weekTotal += pct;
    if (pct === 100) weekDaysComplete++;
    weekBest = Math.max(weekBest, pct);
    return { date: d, pct, rec };
  });
  
  const weekAvg = Math.round(weekTotal / 7);
  
  // Weekly feedback
  let weekEmoji = 'üìà', weekMsg = '';
  if (weekAvg >= 80) {
    weekEmoji = 'üëë';
    weekMsg = `Excellent week! You maintained ${weekAvg}% completion. You\'re crushing your habits with discipline and consistency. Keep this momentum going! üî•`;
  } else if (weekAvg >= 60) {
    weekEmoji = 'üí™';
    weekMsg = `Good effort this week with ${weekAvg}% average completion. You\'re making solid progress, but there\'s room to push harder. You\'ve got this! üìà`;
  } else if (weekAvg >= 40) {
    weekEmoji = '‚ö°';
    weekMsg = `Your week averaged ${weekAvg}% - decent start, but you can do better. Focus on consistency and try to increase your daily completion. You\'re building the habit! üöÄ`;
  } else if (weekAvg > 0) {
    weekEmoji = 'üéØ';
    weekMsg = `You completed ${weekAvg}% this week. The foundation is there. Double down on your commitment and aim for higher consistency next week! üí™`;
  } else {
    weekEmoji = 'üåü';
    weekMsg = 'Start tracking your habits to see your weekly progress!';
  }
  
  document.getElementById('weekly-period').textContent = 'Last 7 days';
  document.getElementById('week-avg').textContent = weekAvg + '%';
  document.getElementById('week-best').textContent = weekBest + '%';
  document.getElementById('week-days-complete').textContent = weekDaysComplete;
  document.getElementById('weekly-feedback').innerHTML = `<div class="feedback-title"><span class="feedback-emoji">${weekEmoji}</span>Weekly Assessment</div><div class="feedback-text">${weekMsg}</div>`;
  
  const weekDaysHtml = weekData.map((d, idx) => {
    const dayName = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.date.getDay()];
    const dateNum = d.date.getDate();
    return `
      <div class="day-cell ${d.pct === 100 ? 'complete' : ''}">
        <div class="day-label">${dayName}</div>
        <div class="day-date">${dateNum}</div>
        <div class="day-pct">${d.pct}%</div>
      </div>
    `;
  }).join('');
  document.getElementById('weekly-days').innerHTML = weekDaysHtml;
  
  // MONTHLY REPORT
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  const monthName = monthStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  
  let monthTotal = 0, monthDaysTracked = 0, monthBest = 0;
  const monthRecords = [];
  for (let d = new Date(monthStart); d <= monthEnd; d.setDate(d.getDate() + 1)) {
    const dateStr = ldate(d);
    const rec = history.find(r => r.date === dateStr);
    if (rec) {
      let done = 0;
      subjects.forEach(s => { if (isDone(s, rec.checks[s.name])) done++; });
      const pct = Math.round(done / Math.max(subjects.length, 1) * 100);
      monthTotal += pct;
      monthDaysTracked++;
      monthBest = Math.max(monthBest, pct);
      monthRecords.push({ date: d, pct, rec });
    }
  }
  
  const monthAvg = monthDaysTracked > 0 ? Math.round(monthTotal / monthDaysTracked) : 0;
  
  // Monthly feedback
  let monthEmoji = 'üìÖ', monthMsg = '';
  if (monthAvg >= 85) {
    monthEmoji = 'üèÜ';
    monthMsg = `Outstanding month! Your ${monthAvg}% average shows incredible dedication. You\'re a habit-building legend! This consistency will transform your life. üëë`;
  } else if (monthAvg >= 70) {
    monthEmoji = '‚≠ê';
    monthMsg = `Great month with ${monthAvg}% average completion! You\'ve shown strong commitment. Keep riding this wave and aim for even higher next month! üöÄ`;
  } else if (monthAvg >= 50) {
    monthEmoji = 'üí°';
    monthMsg = `You averaged ${monthAvg}% this month. You\'re on the right track, but consistency is key. Next month, focus on hitting higher completion rates daily! üìà`;
  } else if (monthAvg > 0) {
    monthEmoji = 'üå±';
    monthMsg = `You logged ${monthAvg}% this month. Every journey starts with a single step. Build on this foundation and strengthen your daily habits! üåü`;
  } else {
    monthEmoji = 'üéØ';
    monthMsg = 'Start tracking to see your monthly performance!';
  }
  
  document.getElementById('monthly-period').textContent = monthName;
  document.getElementById('month-avg').textContent = monthAvg + '%';
  document.getElementById('month-best').textContent = monthBest + '%';
  document.getElementById('month-days').textContent = monthDaysTracked;
  document.getElementById('monthly-feedback').innerHTML = `<div class="feedback-title"><span class="feedback-emoji">${monthEmoji}</span>Monthly Assessment</div><div class="feedback-text">${monthMsg}</div>`;
  
  // Habit performance in month
  const habitStats = subjects.map(habit => {
    let done = 0;
    monthRecords.forEach(r => {
      if (isDone(habit, r.rec.checks[habit.name])) done++;
    });
    const pct = monthDaysTracked > 0 ? Math.round(done / monthDaysTracked * 100) : 0;
    return { habit, pct, done, total: monthDaysTracked };
  });
  
  const habitHtml = habitStats.map(h => {
    const status = h.pct >= 70 ? 'good' : h.pct >= 40 ? '' : 'bad';
    const feedback = h.pct >= 80 ? '‚úÖ Excellent' : h.pct >= 60 ? 'üí™ Good' : h.pct >= 40 ? 'üìà Fair' : '‚ö†Ô∏è Needs work';
    return `
      <div class="summary-habit-row">
        <div class="habit-name-summary">${h.habit.name}</div>
        <div style="display:flex;gap:12px;align-items:center;">
          <div style="text-align:right;">
            <div class="habit-percent ${status}">${h.pct}%</div>
            <div style="font-size:.65rem;color:var(--muted);">${h.done}/${h.total}</div>
          </div>
          <div style="font-size:.75rem;color:var(--muted);min-width:60px;text-align:right;">${feedback}</div>
        </div>
      </div>
    `;
  }).join('');
  document.getElementById('monthly-habits').innerHTML = habitHtml;
}

function renderAch() {
  const g = document.getElementById('ach-grid');
  g.innerHTML = '';
  ACHIEVEMENTS.forEach(a => {
    const unlocked = achievements.includes(a.id);
    const t = document.createElement('div');
    t.className = 'ach-tile' + (unlocked ? ' unlocked' : '');
    t.innerHTML = `<div class="ach-icon">${a.icon}</div><div class="ach-name">${a.name}</div><div class="ach-desc">${a.desc}</div>`;
    g.appendChild(t);
  });
}

function renderSubjects() {
  const list = document.getElementById('slist');
  list.innerHTML = '';
  subjects.forEach(s => {
    const d = document.createElement('div');
    d.style.cssText = 'background:var(--s1);border:1px solid var(--border);border-radius:var(--r-sm);padding:12px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;';
    d.innerHTML = `<div><div style="color:var(--text);font-weight:700;">${s.name}</div><div style="font-size:.75rem;color:var(--muted);">${s.type}</div></div><button class="btn btn-sm btn-del" onclick="delSubj('${encodeURIComponent(s.name)}')">üóëÔ∏è</button>`;
    list.appendChild(d);
  });
}

function logCheck(name, val) {
  const rec = todayRec();
  rec.checks[name] = val;
  const i = history.findIndex(r => r.date === todayStr);
  if (i !== -1) history[i] = rec;
  saveHistory();
  updateAch();
  renderAll();
  const vals = {};
  subjects.forEach(s => vals[s.name] = rec.checks[s.name]);
  pushLog(todayStr, vals);
}

function addSubject() {
  const name = document.getElementById('nn').value.trim();
  const q = document.getElementById('nq').value.trim();
  const type = document.getElementById('nt').value;
  if (!name) { toast('‚ö†Ô∏è Name?', 'err'); return; }
  if (subjects.find(s => s.name === name)) { toast('‚ö†Ô∏è Exists', 'err'); return; }
  subjects.push({ name, type, q: q || `Update ${name}`, def: '0' });
  saveSubjects();
  ensureToday();
  renderAll();
  renderSubjects();
  toast(`‚úÖ Added!`, 'ok');
  document.getElementById('nn').value = '';
  document.getElementById('nq').value = '';
}

function delSubj(encoded) {
  const name = decodeURIComponent(encoded);
  if (!confirm(`Delete "${name}"?`)) return;
  subjects = subjects.filter(s => s.name !== name);
  saveSubjects();
  renderSubjects();
  renderAll();
  toast(`üóëÔ∏è Removed`, 'ok');
}

function resetData() {
  if (!confirm('Reset all?')) return;
  if (!confirm('Really?')) return;
  history = [];
  subjects = [...DEFAULT_SUBJECTS];
  achievements = [];
  saveHistory();
  saveSubjects();
  saveAchievements();
  ensureToday();
  renderAll();
  toast('üîÑ Done!', 'ok');
}

function todayRec() { return history.find(r => r.date === todayStr) || { date: todayStr, checks: {} }; }
function isDone(s, v) {
  if (v === undefined || v === null || v === '') return false;
  if (s.type === 'toggle') return v === 'Yes';
  if (s.type === 'pray') return +v > 0;
  if (s.type === 'slider') return +v >= 6;
  if (s.type === 'notes') return v.trim().length > 0;
  return +v > 0;
}
function fmtV(s, v) {
  if (s.type === 'toggle') return v==='Yes' ? '‚úÖ Yes' : '‚ùå No';
  if (s.type === 'pray') return `üôè ${v}/5`;
  if (s.type === 'slider') return `‚ö° ${v}/10`;
  if (s.type === 'notes') return v.length > 24 ? v.slice(0,22)+'‚Ä¶' : v;
  return `${v}`;
}
function emj(name) { const m = name.match(/\p{Emoji}/u); return m ? m[0] : '‚≠ê'; }
function ldate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function guessType(n) {
  if (/pray/i.test(n)) return 'pray';
  if (/mood|energy|feel/i.test(n)) return 'slider';
  if (/note|link|url/i.test(n)) return 'notes';
  if (/count|rep|page/i.test(n)) return 'number';
  return 'toggle';
}
function bestStreak() {
  let best = 0, cur = 0;
  const sorted = [...history].sort((a,b) => new Date(a.date) - new Date(b.date));
  sorted.forEach((rec, i) => {
    const tot = subjects.length || 1;
    let done = 0;
    subjects.forEach(s => { if (isDone(s, rec.checks?.[s.name])) done++; });
    if (done / tot >= .5) {
      if (i > 0) {
        const p = new Date(sorted[i-1].date+'T12:00:00');
        const c = new Date(rec.date+'T12:00:00');
        if ((c - p) / 86400000 > 1) cur = 1; else cur++;
      } else cur = 1;
      best = Math.max(best, cur);
    } else cur = 0;
  });
  return best;
}
function getStreak() {
  let current = 0;
  const sorted = [...history].sort((a,b) => new Date(b.date) - new Date(a.date));
  for (let i = 0; i < sorted.length; i++) {
    const rec = sorted[i];
    const tot = subjects.length || 1;
    let done = 0;
    subjects.forEach(s => { if (isDone(s, rec.checks?.[s.name])) done++; });
    if (done / tot >= .5) {
      current++;
    } else break;
  }
  return current;
}
function updateAch() {
  const bestStr = bestStreak();
  const today = todayRec();
  let todayDone = 0;
  subjects.forEach(s => { if (isDone(s, today.checks?.[s.name])) todayDone++; });
  const todayPct = subjects.length ? Math.round(todayDone / subjects.length * 100) : 0;

  ACHIEVEMENTS.forEach(a => {
    const unlocked = a.check(subjects, { bestStreak: bestStr, today: todayPct });
    const isUnlocked = achievements.includes(a.id);
    if (unlocked && !isUnlocked) {
      achievements.push(a.id);
      toast(`üèÜ ${a.name}!`, 'ok');
    } else if (!unlocked && isUnlocked) {
      achievements = achievements.filter(x => x !== a.id);
    }
  });
  saveAchievements();
}

function ensureToday() {
  if (!history.find(r => r.date === todayStr)) {
    const checks = {};
    subjects.forEach(s => checks[s.name] = s.def || '');
    history.unshift({ date: todayStr, checks });
    saveHistory();
  }
}

function saveHistory() { localStorage.setItem(SK.history, JSON.stringify(history)); }
function saveSubjects() { localStorage.setItem(SK.subjects, JSON.stringify(subjects)); }
function saveAchievements() { localStorage.setItem(SK.achievements, JSON.stringify(achievements)); }

function toast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + (type || '');
  t.classList.add('show');
  clearTimeout(t._t);
  t._t = setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
